import sqlalchemy
from sqlalchemy.ext.automap import automap_base
from sqlalchemy.orm import sessionmaker
from sqlalchemy import create_engine
import pandas as pd
import calendar
class SQLHelper:
    def __init__(self):
        # Initialize the engine and base
        self.engine = create_engine("sqlite:///storms_final.sqlite")
        self.Base = None
        self.Session = sessionmaker(bind=self.engine)
        self.init_base()
    def init_base(self):
        # Prepare the base for reflecting existing tables
        self.Base = automap_base()
        self.Base.prepare(autoload_with=self.engine)
    def query_storms_by_month(self):
        query = """
        SELECT
            month,
            COUNT(*) AS storm_count
        FROM storm_data
        GROUP BY month
        ORDER BY month;
        """
        with self.Session() as session:
            df = pd.read_sql_query(query, self.engine)
        # Convert month numbers to month names
        df['month_name'] = df['month'].apply(lambda x: calendar.month_name[x])
        result = {
            'labels': df['month_name'].tolist(),
            'values': df['storm_count'].tolist()
        }
        return result
    def query_hurricane_number_bar(self):
        query = """
        SELECT
            category,
            COUNT(*) AS number_of_hurricanes
        FROM storm_data
        WHERE status = 'hurricane'
        GROUP BY category
        ORDER BY category;
        """
        with self.Session() as session:
            df = pd.read_sql_query(query, self.engine)
        result = {
            'categories': df['category'].tolist(),
            'number_of_hurricanes': df['number_of_hurricanes'].tolist()
        }
        return result
    def query_hurricane_by_decade(self):
        query = """
        SELECT
            FLOOR(year / 10) * 10 AS decade_start,
            category,
            COUNT(*) AS hurricane_count
        FROM storm_data
        WHERE status = 'hurricane'
            AND year BETWEEN 1852 AND 2021
        GROUP BY
            FLOOR(year / 10) * 10,
            category
        ORDER BY
            decade_start,
            category;
        """
        with self.Session() as session:
            df = pd.read_sql_query(query, self.engine)
        # Pivot the data for stacked bar chart
        df_pivot = df.pivot(index='decade_start', columns='category', values='hurricane_count').fillna(0)
        # Convert DataFrame to dictionary format suitable for plotting
        result = {
            'decades': df_pivot.index.tolist(),
            'categories': df_pivot.columns.tolist(),
            'data': df_pivot.to_dict(orient='list')
        }
        return result
4:11
<!DOCTYPE html>
<html>
<head>
    <title>Chart.js Example</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <h1>Charts</h1>
    <h2>Storms by Month</h2>
    <canvas id="stormsByMonthChart"></canvas>
    <h2>Hurricane Number by Category</h2>
    <canvas id="hurricaneNumberChart"></canvas>
    <h2>Hurricanes by Decade and Category</h2>
    <canvas id="hurricaneByDecadeChart"></canvas>
    <script>
        async function fetchDataAndRenderCharts() {
            try {
                const [stormsByMonthResponse, hurricaneNumberResponse, hurricaneByDecadeResponse] = await Promise.all([
                    fetch('/api/storms_by_month'),
                    fetch('/api/hurricane_number'),
                    fetch('/api/hurricane_by_decade')
                ]);
                const stormsByMonthData = await stormsByMonthResponse.json();
                const hurricaneNumberData = await hurricaneNumberResponse.json();
                const hurricaneByDecadeData = await hurricaneByDecadeResponse.json();
                // Render Storms by Month Chart as Line Chart
                const ctx1 = document.getElementById('stormsByMonthChart').getContext('2d');
                new Chart(ctx1, {
                    type: 'line',
                    data: {
                        labels: stormsByMonthData.labels,
                        datasets: [{
                            label: 'Number of Storms',
                            data: stormsByMonthData.values,
                            borderColor: 'rgba(173, 216, 230, 1)',
                            borderWidth: 1,
                            fill: false
                        }]
                    },
                    options: {
                        scales: {
                            x: {
                                title: {
                                    display: true,
                                    text: 'Month'
                                }
                            },
                            y: {
                                title: {
                                    display: true,
                                    text: 'Number of Storms'
                                },
                                beginAtZero: true
                            }
                        }
                    }
                });
                // Render Hurricane Number by Category Chart
                const ctx2 = document.getElementById('hurricaneNumberChart').getContext('2d');
                new Chart(ctx2, {
                    type: 'bar',
                    data: {
                        labels: hurricaneNumberData.categories,
                        datasets: [{
                            label: 'Number of Hurricanes',
                            data: hurricaneNumberData.number_of_hurricanes,
                            backgroundColor: [
                                'blue',  // Category 1
                                'green', // Category 2
                                'yellow', // Category 3
                                'orange', // Category 4
                                'red'     // Category 5
                            ],
                            borderColor: [
                                'blue',  // Category 1
                                'green', // Category 2
                                'yellow', // Category 3
                                'orange', // Category 4
                                'red'     // Category 5
                            ],
                            borderWidth: 1
                        }]
                    },
                    options: {
                        scales: {
                            y: {
                                beginAtZero: true
                            }
                        }
                    }
                });
                // Render Hurricanes by Decade and Category Chart
                const ctx3 = document.getElementById('hurricaneByDecadeChart').getContext('2d');
                new Chart(ctx3, {
                    type: 'bar',
                    data: {
                        labels: hurricaneByDecadeData.decades,
                        datasets: hurricaneByDecadeData.categories.map(category => ({
                            label: `Category ${category}`,
                            data: hurricaneByDecadeData.data[category] || [],
                            backgroundColor: getCategoryColor(category),
                            borderColor: getCategoryColor(category),
                            borderWidth: 1
                        }))
                    },
                    options: {
                        scales: {
                            x: {
                                stacked: true
                            },
                            y: {
                                stacked: true,
                                beginAtZero: true
                            }
                        }
                    }
                });
            } catch (error) {
                console.error('Error fetching data or rendering charts:', error);
            }
        }
        function getCategoryColor(category) {
            const colors = {
                1: 'blue',
                2: 'green',
                3: 'yellow',
                4: 'orange',
                5: 'red'
            };
            return colors[category] || 'gray'; // Default color if category is not found
        }
        // Call the function to fetch data and render charts
        fetchDataAndRenderCharts();
    </script>
</body>
</html>







